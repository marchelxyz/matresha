# Диагностика проблемы с API ключами на Railway

## Проблема: `providers: []` - пустой массив

Если сервер возвращает пустой массив `providers`, это означает, что **ни один API ключ не найден**.

## Шаг 1: Проверьте диагностический endpoint

Откройте в браузере:
```
https://ваш-домен.railway.app/api/debug/env
```

Этот endpoint покажет:
- Какие переменные окружения с `API_KEY` в имени найдены
- Длину каждого значения (без показа самого ключа)
- Первые и последние символы (для проверки формата)

**Ожидаемый результат для Groq:**
```json
{
  "success": true,
  "data": {
    "env_vars": {
      "GROQ_API_KEY": {
        "exists": true,
        "has_value": true,
        "length": 51,
        "starts_with": "gsk_",
        "ends_with": "..."
      }
    },
    "api_key_vars_found": 1
  }
}
```

## Шаг 2: Проверьте endpoint `/api/providers` с диагностикой

Откройте:
```
https://ваш-домен.railway.app/api/providers
```

Теперь он вернет детальную информацию:
```json
{
  "success": true,
  "data": {
    "providers": ["groq"],
    "all": ["openai", "gemini", "claude", "groq", "mistral"],
    "status": {
      "groq": {
        "available": true,
        "has_key": true,
        "env_var": "GROQ_API_KEY",
        "env_var_exists": true
      }
    },
    "env_vars": {
      "GROQ_API_KEY": {
        "exists": true,
        "has_value": true,
        "length": 51,
        "starts_with": "gsk_"
      }
    },
    "debug": {
      "python_env_keys": ["GROQ_API_KEY"]
    }
  }
}
```

## Возможные проблемы и решения

### Проблема 1: `env_vars.GROQ_API_KEY.exists: false`

**Причина:** Переменная не установлена в Railway или имеет неправильное имя.

**Решение:**
1. Откройте Railway Dashboard → Ваш проект → **Variables**
2. Проверьте, что переменная называется именно **`GROQ_API_KEY`** (заглавными буквами)
3. Убедитесь, что значение скопировано полностью
4. **ВАЖНО:** После добавления/изменения переменной нажмите **Redeploy** (перезапуск сервиса)

### Проблема 2: `env_vars.GROQ_API_KEY.exists: true`, но `has_value: false`

**Причина:** Переменная существует, но значение пустое.

**Решение:**
1. Проверьте значение переменной в Railway Variables
2. Убедитесь, что значение не пустое
3. Убедитесь, что нет лишних пробелов или кавычек
4. Перезапустите сервис

### Проблема 3: `starts_with` не `"gsk_"`

**Причина:** Неправильный формат ключа или скопирован не полностью.

**Решение:**
1. Проверьте ключ на https://console.groq.com
2. Убедитесь, что ключ начинается с `gsk_`
3. Скопируйте ключ заново
4. Вставьте в Railway Variables
5. Перезапустите сервис

### Проблема 4: Переменная есть, но `providers` все равно пустой

**Причина:** Возможно, проблема с чтением переменных в коде.

**Решение:**
1. Проверьте логи Railway:
   - Railway Dashboard → Deployments → последний деплой → Logs
2. Ищите ошибки при запуске сервера
3. Убедитесь, что сервер перезапущен после добавления переменной

## Пошаговая инструкция для Railway

### 1. Добавление переменной окружения

1. Откройте https://railway.app
2. Войдите в свой аккаунт
3. Выберите ваш проект
4. Перейдите в раздел **Variables** (в боковом меню)
5. Нажмите **+ New Variable**
6. В поле **Name** введите: `GROQ_API_KEY`
7. В поле **Value** вставьте ваш ключ от Groq (начинается с `gsk_`)
8. Нажмите **Add**

### 2. Перезапуск сервиса

**ВАЖНО:** После добавления переменной **обязательно перезапустите сервис!**

1. В Railway Dashboard перейдите в раздел **Deployments**
2. Найдите последний деплой
3. Нажмите на три точки (⋮) справа
4. Выберите **Redeploy** или **Restart**

Или:
1. Перейдите в раздел **Settings**
2. Найдите раздел **Service**
3. Нажмите **Redeploy**

### 3. Проверка

После перезапуска подождите 1-2 минуты и проверьте:

1. **Health check:**
   ```
   https://ваш-домен.railway.app/api/health
   ```
   Должен вернуть: `{"status": "ok", ...}`

2. **Диагностика переменных:**
   ```
   https://ваш-домен.railway.app/api/debug/env
   ```
   Должен показать `GROQ_API_KEY` с `exists: true` и `has_value: true`

3. **Провайдеры:**
   ```
   https://ваш-домен.railway.app/api/providers
   ```
   Должен вернуть `groq` в массиве `providers`

## Частые ошибки

### ❌ Ошибка: Переменная добавлена, но сервер не видит

**Причины:**
- Сервис не перезапущен после добавления переменной
- Неправильное имя переменной (проверьте регистр: `GROQ_API_KEY`, не `groq_api_key`)
- Переменная добавлена в неправильный сервис (если у вас несколько сервисов)

**Решение:**
1. Проверьте имя переменной: должно быть `GROQ_API_KEY` (заглавными)
2. Перезапустите сервис (Redeploy)
3. Подождите 1-2 минуты
4. Проверьте через `/api/debug/env`

### ❌ Ошибка: Ключ не работает

**Причины:**
- Ключ истек или был удален
- Ключ скопирован не полностью
- Лишние пробелы или символы в значении

**Решение:**
1. Проверьте ключ на https://console.groq.com
2. Создайте новый ключ, если нужно
3. Скопируйте ключ полностью (обычно 51 символ)
4. Вставьте в Railway без пробелов в начале/конце
5. Перезапустите сервис

## Проверка через Railway CLI (опционально)

Если у вас установлен Railway CLI:

```bash
# Проверка переменных
railway variables

# Должно показать GROQ_API_KEY=...
```

## Что делать дальше

После того как `/api/providers` вернет `groq` в массиве `providers`:

1. ✅ API ключ настроен правильно
2. ✅ Сервер видит переменную окружения
3. ✅ Можно использовать Groq API

Теперь проверьте frontend:
- Убедитесь, что `API_BASE_URL` в `telegram-config.js` указывает на ваш Railway backend
- Откройте приложение и попробуйте отправить сообщение
- Выберите провайдер "Groq (Llama)" в селекторе

## Если ничего не помогает

1. **Проверьте логи Railway:**
   - Railway Dashboard → Deployments → Logs
   - Ищите ошибки при запуске

2. **Проверьте формат ключа:**
   - Должен начинаться с `gsk_`
   - Длина обычно 51 символ
   - Без пробелов и кавычек

3. **Создайте новый ключ:**
   - https://console.groq.com → API Keys
   - Создайте новый ключ
   - Добавьте в Railway
   - Перезапустите сервис

4. **Проверьте, что используете правильный сервис:**
   - Если у вас несколько сервисов в проекте, убедитесь, что переменная добавлена в правильный
