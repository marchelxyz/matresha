# База данных для истории чата

## Описание

Система использует **PostgreSQL** для хранения истории чатов пользователей. SQLite поддерживается только для локальной разработки.

**Важно:** Для продакшена обязательно используйте PostgreSQL!

## Модели данных

### Chat (Сессия чата)
- `id` - уникальный идентификатор
- `user_id` - ID пользователя Telegram
- `user_name` - имя пользователя
- `username` - username пользователя
- `provider` - используемый AI провайдер
- `created_at` - дата создания
- `updated_at` - дата последнего обновления

### Message (Сообщение)
- `id` - уникальный идентификатор
- `chat_id` - ID сессии чата (внешний ключ)
- `role` - роль отправителя ('user' или 'assistant')
- `content` - содержимое сообщения
- `provider` - AI провайдер, использованный для ответа
- `temperature` - параметр температуры
- `max_tokens` - максимальное количество токенов
- `created_at` - дата создания

## Настройка

### Продакшен (PostgreSQL) - ОБЯЗАТЕЛЬНО

Для продакшена используется **PostgreSQL**. Настройка зависит от платформы:

#### Railway
1. Добавьте PostgreSQL сервис в ваш проект на Railway
2. Railway автоматически установит переменную окружения `DATABASE_URL`
3. Таблицы создадутся автоматически при первом запуске приложения

#### Другие платформы
1. Создайте PostgreSQL базу данных
2. Установите переменную окружения `DATABASE_URL`:
   ```
   DATABASE_URL=postgresql://user:password@host:port/dbname
   ```
   или (для некоторых провайдеров):
   ```
   DATABASE_URL=postgres://user:password@host:port/dbname
   ```

3. Таблицы создадутся автоматически при первом запуске

### Локальная разработка (SQLite - опционально)
Для локальной разработки можно использовать SQLite (если `DATABASE_URL` не установлен). 
База данных создается автоматически в файле `backend/chat_history.db`.

**Рекомендация:** Для тестирования лучше использовать локальный PostgreSQL.

## API Эндпоинты

### Получить историю чата
```
GET /api/chat/history?user_id=<user_id>
GET /api/chat/history?chat_id=<chat_id>
```

### Получить сообщения чата
```
GET /api/chat/<chat_id>/messages?limit=50
```

## Автоматическое сохранение

Все сообщения автоматически сохраняются в базу данных при отправке через:
- `/api/chat` (обычный запрос)
- `/api/chat/stream` (потоковый запрос)

История загружается автоматически при открытии приложения в frontend.

## Контекст для AI

История чата автоматически передается в AI провайдеры для поддержания контекста разговора. Это позволяет AI "помнить" предыдущие сообщения в рамках одной сессии.
